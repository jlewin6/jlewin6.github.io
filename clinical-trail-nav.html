
<!DOCTYPE html>
<head>
<style>

path.link {
  fill: none;
  stroke: #666;
  stroke-width: 1.5px;
}

circle {
  fill: #ccc;
  stroke: #fff;
  stroke: black;
  stroke-width: 1.5px;
}

text {
  fill: #000;
  font: 10px sans-serif;
  pointer-events: none;
}

</style>
<meta charset="utf-8">
<title></title>
</head>

<body>
<script type="text/javascript" src="../lib/d3.v5.min.js"></script>
<script>

//reference: https://vizhub.com/curran/f192e44054aa4731b5ceba1b833028d6

  const c1 = {level:3, collapsed: true,condition:'Type 2 Diabetes',intervention_type:undefined,intervention:undefined, nct_id:undefined}
  const c2 = {level:3, collapsed: true, condition:'Hypertension',intervention_type:undefined,intervention:undefined, nct_id:undefined}
  const c3 = {level:3, collapsed: true, condition:'Depression',intervention_type:undefined,intervention:undefined, nct_id:undefined}

  const t1 = {level:2, collapsed: true, condition:'Hypertension',intervention_type:'Behavioral',intervention:undefined, nct_id:undefined}
  const t2 = {level:2, collapsed: true, condition:'Hypertension',intervention_type:'Drug',intervention:undefined, nct_id:undefined}
  const t3 = {level:2, collapsed: true, condition:'Hypertension',intervention_type:'Device',intervention:undefined, nct_id:undefined}

  const i1 = {level:1, collapsed: true, condition:'Hypertension',intervention_type:'Drug',intervention:'Aliskiren', nct_id:undefined}
  const i2 = {level:1, collapsed: true, condition:'Hypertension',intervention_type:'Drug',intervention:'Atorvastatin', nct_id:undefined}

  const s1 = {level:0, collapsed: true, condition:'Hypertension',intervention_type:'Drug',intervention:'Aliskiren', nct_id:1}
  const s2 = {level:0, collapsed: true, condition:'Hypertension',intervention_type:'Drug',intervention:'Aliskiren', nct_id:2}
  const s3 = {level:0, collapsed: true, condition:'Hypertension',intervention_type:'Drug',intervention:'Aliskiren', nct_id:3}
  const s4 = {level:0, collapsed: true, condition:'Hypertension',intervention_type:'Drug',intervention:'Aliskiren', nct_id:4}
  const s5 = {level:0, collapsed: true, condition:'Hypertension',intervention_type:'Drug',intervention:'Aliskiren', nct_id:5}

  const s6 = {level:0, collapsed: true, condition:'Hypertension',intervention_type:'Drug',intervention:'Atorvastatin', nct_id:5}
  const s7 = {level:0, collapsed: true, condition:'Hypertension',intervention_type:'Drug',intervention:'Atorvastatin', nct_id:6}

  var links = [{source:c2,target:t2},
    {source:c2,target:t1},
    {source:c2,target:t2},
    {source:c2,target:t3},
    {source:t2,target:i1},
    {source:t2,target:i2},
    {source:i1,target:s1},
    {source:i1,target:s2},
    {source:i1,target:s3},
    {source:i1,target:s4},
    {source:i1,target:s5},
    {source:i2,target:s6},
    {source:i2,target:s7},
  ]

  var nodes = [c1,c2,c3,t1,t2,t3,i1,i2,s1,s2,s3,s4,s5,s6,s7];


  var width = 1200,
      height = 700;

  var force = d3.forceSimulation()
      .nodes(nodes)
      .force("link", d3.forceLink(links).distance(100))
      .force('center', d3.forceCenter(width / 2, height / 2))
      .force("charge", d3.forceManyBody().strength(-50))
      .on("tick", tick);

  var svg = d3.select("body").append("svg")
      .attr("width", width)
      .attr("height", height);

  // add the links
  var path = svg.append("g")
      .selectAll("path")
      .data(links)
      .enter()
      .append("path")

  // define the nodes
  var node = svg.selectAll(".node")
      .data(force.nodes())
      .enter().append("g")
      .attr("class", "node")
      .call(d3.drag()
          .on("start", dragstarted)
          .on("drag", dragged)
          .on("end", dragended))
      .on("dblclick", dblclick);

  //Colors
  var myColor = d3.scaleLinear().domain([0,3])
  .range(["#ece7f2", "#2b8cbe"])


  //create function for counting child nodes of a given node
  function count_child_nodes(d){
    return nodes.filter(function(l) {
     if (d.level == 0) {
        return ((l.condition == d.condition)&(l.intervention_type == d.intervention_type) & (l.intervention == d.intervention)&(l.nct_id == d.nct_id))
      }
     else if (d.level == 1) {
        return ((l.condition == d.condition)&(l.intervention_type == d.intervention_type) & (l.intervention == d.intervention))
     } else if (d.level == 2){
        return ((l.condition == d.condition)&(l.intervention_type == d.intervention_type))
     } else if (d.level ==3) {
        return (l.condition == d.condition)
      }
    }).length
  }


  // add the nodes
   node.append("circle")
      .attr("r", function(d) {
     d.weight = count_child_nodes(d)
     d.radius = 10 + (d.weight * 5)
     return d.radius;
     })
     .style("fill", function(d){return myColor(d.level) })
       .style("stroke",function(d){return myColor(d.level) })

   force.force("collide", d3.forceCollide(function(d){return d.radius }).iterations(1))

   node.append("text")
          .attr("text-anchor", "middle")
           //.attr("dx", 0)
           .attr("dy", ".35em")
           .style("font-weight", "bold")
           .text(function(d) {
             if (d.level==0){
               return (d.nct_id)
             } else if (d.level ==1){
               return (d.intervention)
             } else if (d.level==2){
               return (d.intervention_type)
             } else if (d.level==3){
               return (d.condition)
             }})
            .style("font-size",function(d) {
              return 10 + count_child_nodes(d) *0.5
            } )




     // add the lines
     function tick() {
         path.attr("d", function(d) {
             var dx = d.target.x - d.source.x,
                 dy = d.target.y - d.source.y,
                 dr = 0;
             return "M" +
                 d.source.x + "," +
                 d.source.y + "A" +
                 dr + "," + dr + " 0 0,1 " +
                 d.target.x + "," +
                 d.target.y;
         });
         path.style("stroke", function(d){return myColor(d.source.level) });
         path.style("stroke-width",2);

         node.attr("transform", function(d) {
             return "translate(" + d.x + "," + d.y + ")";
         });
     };

  function dragstarted(d) {
      d.fixed =true
      if (!d3.event.active) force.alphaTarget(0.3).restart();
      d.fx = d.x;
      d.fy = d.y;
      d3.select(this) // `this` is the node where drag happend
          .select("circle");
  };

  function dragged(d) {
      d.fx = d3.event.x;
      d.fy = d3.event.y;
  };

  function dragended(d) {
      if (!d3.event.active) force.alphaTarget(0);
      if (d.fixed == true) {
          d.fx = d.x;
          d.fy = d.y;
      }
      else {
        d.fx = null;
        d.fy = null;

      }
  };

  function dblclick(d) {
   //alert("node was double clicked")
   d.fixed = false;
   d.fx = null;
   d.fy = null;
   d3.select(this) // `this` is the node where drag happend
       .select("circle")
       .style("fill", function(d){return myColor(d.level) });

   //if
   var n = d3.select(this).datum()
   

   d3.select(this).datum(function(d) {
    if (n.collapsed) {
      d.collapsed = false;
    } else {
      d.collapsed = true;
    }
    return d })


   n = d3.select(this).datum()

   if (n.collapsed) {
     opacity = 100
   } else {
     opacity = 0
   }


   d3.selectAll(".node")
     .filter(function(d) {
       if (n.level == 1){
        return ((d.condition == n.condition)&&(d.intervention_type == n.intervention_type) && (d.intervention == n.intervention) && (d.nct_id!= undefined));
      }else if (n.level ==2){
        return ((d.condition == n.condition)&&(d.intervention_type == n.intervention_type) && (d.intervention!= undefined));
      }else if (n.level ==3){
        return ((d.condition == n.condition)&&(d.intervention_type!= undefined));
      }
    }).style("opacity",opacity)
      .datum(function(d) {
        if (n.collapsed) {
          d.radius=10 + (d.weight * 5)
        } else{
          d.radius=0
        }
          return d
      });

     d3.selectAll("path").filter(function(d) {
     if (n.level == 1){

       return ((d.target.condition == n.condition)&&(d.target.intervention_type == n.intervention_type) && (d.target.intervention == n.intervention) & (d.target.nct_id!= undefined))
     }else if (n.level ==2){
       return ((d.target.condition == n.condition)&&(d.target.intervention_type == n.intervention_type)  && (d.target.intervention != undefined))
     }else if (n.level ==3){
       return ((d.target.condition == n.condition)&&(d.target.intervention_type != undefined));
     }
   }).style("opacity",opacity)



   force.force("collide", d3.forceCollide(function(l){return l.radius }).iterations(1))


}

</script>
</body>
</html>
